<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHPB Data Processor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            display: flex;
            height: 100vh;
            background-color: #f5f7fa;
        }

        /* å·¦ä¾§æ§åˆ¶é¢æ¿ */
        .control-panel {
            width: 10%;
            min-width: 200px;
            background: white;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .panel-section {
            margin-bottom: 20px;
        }

        .panel-section h3 {
            margin-bottom: 12px;
            color: #2c3e50;
            font-size: 16px;
        }

        button, input[type="file"], select {
            width: 100%;
            padding: 10px;
            margin: 6px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #fff;
            cursor: pointer;
        }

        button:hover {
            background-color: #e9ecef;
        }

        button.primary {
            background-color: #4CAF50;
            color: white;
            border: none;
        }

        button.primary:hover {
            background-color: #45a049;
        }

        .file-input-container {
            position: relative;
        }

        .file-input-container input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }


        .selected-file {
            margin-top: 10px;
            padding: 10px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 6px;
            text-align: center;
        }

        /* å›¾è¡¨åŒºåŸŸ */
        .chart-container {
            width: 75%;
            position: relative;
            background: #fafafa;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #chart {
            width: 100%;
            height: 100%;
            min-height: 400px;
            background: white;
            border: 1px solid #eee;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        /* æ‚¬æµ®æ“ä½œæŒ‰é’® */
        .floating-buttons {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: 1px solid #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            transition: background 0.2s;
        }

        .action-btn:hover {
            background: #f0f0f0;
        }

        .action-btn i {
            font-size: 16px;
            color: #333;
        }

        .calculate-panel{
            width: 15%;
            min-width: 220px;
            background: white;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        /* æ ·å“ç®¡ç†éƒ¨åˆ† */
        .sample-management {
            margin-top: 20px;
        }

        .sample-management .new-sample-button {
            width: 100%;
            padding: 10px;
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .sample-management .new-sample-button:hover {
            background: #e68a00;
        }

        .sample-management .new-Hopkinson-button {
            width: 100%;
            padding: 10px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .sample-management .new-Hopkinson-button:hover {
            background: #1f8cdf;
        }

        .panel-section .calculation-button {
            width: 100%;
            padding: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .panel-section .calculation-button:hover {
            background: #45a049;
        }

        .sample-display {
            margin-top: 10px;
            padding: 10px;
            background: #f9f9f9;
            /*border: 1px solid #ddd;*/
            border-radius: 6px;
            text-align: center;
            font-size: 13px;
            /*font-style: italic;*/
        }

        /* çŠ¶æ€æ  */
        .status-bar {
            margin-top: 20px;
            padding: 10px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 6px;
            text-align: center;
        }

        /* æ–°å»ºæ ·å“æ¨¡æ€æ¡†æ ·å¼ */
        .sample-form-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
            padding: 30px;
        }

        .sample-form-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .sample-form-header h2 {
            color: #2c3e50;
            font-size: 24px;
            margin-bottom: 5px;
        }

        .sample-form-group {
            margin-bottom: 20px;
        }

        .sample-form-group label {
            display: block;
            margin-bottom: 8px;
            color: #34495e;
            font-weight: 500;
        }

        .sample-form-group input, .sample-form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .sample-form-group input:focus, .sample-form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .sample-form-row {
            display: flex;
            gap: 15px;
        }

        .sample-form-row .sample-form-group {
            flex: 1;
        }

        .sample-button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-save {
            background-color: #4CAF50;
            color: white;
        }

        .btn-save:hover {
            background-color: #45a049;
        }

        .btn-cancel {
            background-color: #95a5a6;
            color: white;
        }

        .btn-cancel:hover {
            background-color: #7f8c8d;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

    </style>
</head>
<body>

    <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
    <div class="control-panel">
        <!-- æ•°æ®åŠ è½½ -->
        <div class="panel-section">
            <h3>ğŸ“ æ•°æ®åŠ è½½</h3>
            <div class="file-input-container">
                <input type="file" id="incidentFile" accept=".csv,.txt,.dat" />
                <div id="incidentFileName" class="selected-file">é€‰æ‹©å…¥å°„æ³¢æ–‡ä»¶</div>
            </div>
            <div class="file-input-container">
                <input type="file" id="transmittedFile" accept=".csv,.txt,.dat" />
                <div id="transmittedFileName" class="selected-file">é€‰æ‹©é€å°„æ³¢æ–‡ä»¶</div>
            </div>
            <button class="primary" onclick="loadData()">åŠ è½½æ•°æ®</button>
            <canvas width="266" height="50"></canvas>
        </div>

        <!-- å‚æ•°è®¾ç½® -->
        <div class="panel-section sample-management">
            <h3>âš™ï¸ å‚æ•°è®¾ç½®</h3>
            <button class="new-sample-button" onclick="openNewSampleDialog()">æ–°å»ºæ ·å“</button>
            <div id="sampleDisplay" class="sample-display">æ— æ ·å“ä¿¡æ¯</div>
            <button class = "new-Hopkinson-button" onclick="openNewHopkinsonDialog()">æ–°å»ºæ†å‚æ•°</button>
            <div id="rodParameters" class="sample-display">æ†å‚æ•°ï¼šæœªè®¾ç½®</div>
        </div>

        <!-- æ“ä½œçŠ¶æ€ -->
        <div class="panel-section status-bar">
            <h3>â„¹ï¸ æ“ä½œçŠ¶æ€</h3>
            <p id="status">ç­‰å¾…æ•°æ®åŠ è½½...</p>
        </div>

    </div>

    <!-- ä¸­é—´å›¾è¡¨åŒºåŸŸ -->
    <div class="chart-container">
        <!-- é€‰é¡¹å¡æ§ä»¶ -->
        <div class="chart-tabs" style="position: absolute; top: 0; width: 100%; height: 8%; display: flex; background: #f0f0f0; border-top: 1px solid #ddd;">
            <button id="wave" class="tab-btn active" onclick="switchChartTab('wave')" style="flex: 1; padding: 10px; border: none; background: #4CAF50; color: white; cursor: pointer;">æ³¢å½¢å›¾</button>
            <button id="fft" class="tab-btn" onclick="switchChartTab('fft')" style="flex: 1; padding: 10px; border: none; background: #e0e0e0; cursor: pointer;">é¢‘è°±å›¾</button>
            <button id="crop" class="tab-btn" onclick="switchChartTab('crop')" style="flex: 1; padding: 10px; border: none; background: #e0e0e0; cursor: pointer;">æ—¶åŸŸå¯¹é½</button>
            <button id="result" class="tab-btn" onclick="switchChartTab('result')" style="flex: 1; padding: 10px; border: none; background: #e0e0e0; cursor: pointer;">è®¡ç®—ç»“æœ</button>
        </div>

        <div id="chart" style="position: absolute; top: 8%; left: 0; width: 100%; height: 92%;">
            <svg width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none" style="background:white;">
                <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#888">æ— æ•°æ®å¯¼å…¥</text>
            </svg>
        </div>

        <!-- æ‚¬æµ®æŒ‰é’® -->
        <div class="floating-buttons">
            <div class="action-btn" title="æ”¾å¤§" onclick="zoomIn()">
                <i>ğŸ”+</i>
            </div>
            <div class="action-btn" title="ç¼©å°" onclick="zoomOut()">
                <i>ğŸ”âˆ’</i>
            </div>
            <div class="action-btn" title="æ‹–åŠ¨æ¨¡å¼" onclick="togglePan()">
                <i>âœ‹</i>
            </div>
            <div class="action-btn" title="é‡ç½®è§†å›¾" onclick="resetView()">
                <i>â†º</i>
            </div>
        </div>
    </div>

    <!-- å³ä¾§æ§åˆ¶é¢æ¿ -->
    <div class="calculate-panel">
        <!-- æ•°æ®æ»¤æ³¢ -->
        <div class="panel-section">
            <h3>ğŸ“Š æ•°æ®è°ƒæ•´</h3>
                <h4>æ»¤æ³¢å‚æ•°</h4>
                <div style="margin-top:10px;">
                    <label for="lowFreqSlider">ä½é¢‘æˆªæ­¢:  </label>
                    <span id="lowFreqValue" style="margin-left: 10px;">0 Hz</span>
                    <div style="display: flex; align-items: center; margin-top: 5px;">
                        <input type="range" id="lowFreqSlider" min="0" max="1000000" value="0" oninput="updateLowFreq(this.value)" style="flex: 1;" />
                    </div>
                </div>

                <div style="margin-top:10px;">
                    <label for="lowFreqSlider">é«˜é¢‘æˆªæ­¢:  </label>
                    <span id="highFreqValue" style="margin-left: 10px;">180000 Hz</span>
                    <div style="display: flex; align-items: center; margin-top: 5px;">
                        <input type="range" id="highFreqSlider" min="0" max="1000000" value="180000" oninput="updateHighFreq(this.value)" style="flex: 1;" />
                    </div>
                </div>
                <button onclick="applyFilter()">åº”ç”¨æ»¤æ³¢</button>

                <h4>åŸºçº¿è°ƒæ•´</h4>
                <button onclick="function baselineCorrection() {
                    if (document.getElementById('baselineCorrection').style.display === 'block') {
                        document.getElementById('baselineCorrection').style.display = 'none';
                    }else{
                        document.getElementById('baselineCorrection').style.display = 'block';
                    }
                }
                baselineCorrection()">åŸºçº¿è°ƒæ•´</button>

                <div id="baselineCorrection" style="margin-top:10px; display:none;">
                    <label for="IncBaseline">å…¥å°„æ³¢åŸºçº¿è°ƒæ•´</label>
                    <div style="display: flex; align-items: center; margin-top: 5px;">
                        <input type="range" id="IncBaseline" min="0" max="1000" value="500" oninput="updateIncBaseline(this.value)" style="flex: 1;" />
                        <input type="number" id="IncBaselineInput" min="-1" max="1" value="0" onchange="function updateIncBaselineInput(value) {
                            document.getElementById('IncBaseline').value = value*500 + 500;
                            document.getElementById('IncBaselineInput').value = value;
                            updateIncBaseline(value*500 + 500);
                        }
                        updateIncBaselineInput(this.value)" style="width: 80px; margin-left: 10px; padding: 5px;" />
                    </div>
                    <label for="TransBaseline">é€å°„æ³¢åŸºçº¿è°ƒæ•´</label>
                    <div style="display: flex; align-items: center; margin-top: 5px;">
                        <input type="range" id="TransBaseline" min="0" max="1000" value="500" oninput="updateTransBaseline(this.value)" style="flex: 1;" />
                        <input type="number" id="TransBaselineInput" min="-1" max="1" value="0" onchange="function updateTransBaselineInput(value) {
                            document.getElementById('TransBaseline').value = value*500 + 500;
                            document.getElementById('TransBaselineInput').value = value;
                            updateTransBaseline(value*500 + 500);
                        }
                        updateTransBaselineInput(this.value)" style="width: 80px; margin-left: 10px; padding: 5px;" />
                    </div>
                </div>

                <h4>æ—¶åŸŸå¯¹é½</h4>
                <button onclick="alignWithTime()">æ—¶åŸŸå¯¹é½</button>
                <button onclick="alignManually()">æ‰‹åŠ¨è°ƒæ•´</button>

                <div id="alignManually" style="margin-top:10px; display:none;">
                    <label for="incManually">å…¥å°„æ³¢è°ƒæ•´åç§»</label>
                    <div style="display: flex; align-items: center; margin-top: 5px;">
                        <input type="range" id="incManually" min="0" max="2000" value="1000" oninput="updateInc(this.value)" style="flex: 1;" />
                        <input type="number" id="incManuallyInput" min="-1000" max="1000" value="0" onchange="updateIncFromInput(this.value)" style="width: 80px; margin-left: 10px; padding: 5px;" />

                    </div>
                    <label for="refManually">åå°„æ³¢è°ƒæ•´åç§»</label>
                    <div style="display: flex; align-items: center; margin-top: 5px;">
                        <input type="range" id="refManually" min="0" max="2000" value="1000" oninput="updateRef(this.value)" style="flex: 1;" />
                        <input type="number" id="refManuallyInput" min="-1000" max="1000" value="0" onchange="updateRefFromInput(this.value)" style="width: 80px; margin-left: 10px; padding: 5px;" />
                    </div>
                    <label for="transManually">é€å°„æ³¢è°ƒæ•´åç§»</label>
                    <div style="display: flex; align-items: center; margin-top: 5px;">
                        <input type="range" id="transManually" min="0" max="2000" value="1000" oninput="updateTrans(this.value)" style="flex: 1;" />
                        <input type="number" id="transManuallyInput" min="-1000" max="1000" value="0" onchange="updateTransFromInput(this.value)" style="width: 80px; margin-left: 10px; padding: 5px;" />
                    </div>
                </div>


            <canvas width="266" height="50"></canvas>
        </div>

        <!-- æ•°æ®ä¿å­˜ -->
        <div class="panel-section">
            <h3>ğŸ’¾ æ•°æ®è®¡ç®—ä¸ä¿å­˜</h3>
                <div class="calculate-method-group">
                    <label for="calculateMethod">è®¡ç®—æ–¹æ³•</label>
                    <select id="calculateMethod" name="calculateMethod" required>
                        <option value="incAndTrans">åŒæ³¢æ³•(å…¥å°„+é€å°„)</option>
                        <option value="refAndTrans">åŒæ³¢æ³•(åå°„+é€å°„)</option>
                        <option value="threeWave">ä¸‰æ³¢æ³•</option>
                    </select>
                </div>
            <button class = calculation-button onclick="startCalculation()">å¼€å§‹è®¡ç®—</button>
            <progress id="calculationProgress" value="0" max="100" style="margin-top:10px;display:none;"></progress>

            <button onclick="exportResults()">å¯¼å‡ºç»“æœ</button>
        </div>

    </div>

    <!-- é€‰æ‹©æ›²çº¿è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="serialModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="sample-form-container">
                <div class="sample-form-header">
                    <h2>æ›²çº¿è®¾ç½®</h2>
                </div>
                <form id="serialForm">
                     <div class="serial-form-group">
                        <label for="serialType">æ³¢ç±»å‹</label>
                        <select id="serialType" name="serialType" required>
                            <option value="inc">å…¥å°„æ³¢</option>
                            <option value="ref">åå°„æ³¢</option>
                            <option value="trans">é€å°„æ³¢</option>
                        </select>
                    </div>

                    <div class="sample-button-group">
                        <button type="button" class="btn btn-save" onclick="checkSerial()">ç¡®è®¤</button>
                        <button type="button" class="btn btn-cancel" onclick="closeSerial()">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- æ ·å“å‚æ•°è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="sampleModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="sample-form-container">
                <div class="sample-form-header">
                    <h2>æ ·å“å‚æ•°è®¾ç½®</h2>
                    <p>è¯·è¾“å…¥æ ·å“è¯¦ç»†ä¿¡æ¯</p>
                </div>

                <form id="sampleForm">
                    <div class="sample-form-group">
                        <label for="sampleNumber">æ ·å“ç¼–å·</label>
                        <input type="text" id="sampleNumber" name="sampleNumber" placeholder="è¯·è¾“å…¥æ ·å“ç¼–å·" required>
                    </div>
                    <div class="sample-form-group">
                        <label for="sampleName">æ ·å“åç§°</label>
                        <input type="text" id="sampleName" name="sampleName" placeholder="è¯·è¾“å…¥æ ·å“åç§°" required>
                    </div>
                    <div class="sample-form-group">
                        <label for="sampleMaterial">æ ·å“æè´¨</label>
                        <input type="text" id="sampleMaterial" name="sampleMaterial" placeholder="è¯·è¾“å…¥æ ·å“æè´¨" required>
                    </div>

                    <div class="sample-form-row">
                        <div class="sample-form-group">
                            <label for="sampleArea">æˆªé¢ç›´å¾„Ã¸ (mm)</label>
                            <input type="number" id="sampleArea" name="sampleArea" placeholder="è¯·è¾“å…¥æˆªé¢ç§¯" step="0.01" min="0" required>
                        </div>

                        <div class="sample-form-group">
                            <label for="sampleLength">æ ·å“é•¿åº¦l (mm)</label>
                            <input type="number" id="sampleLength" name="sampleLength" placeholder="è¯·è¾“å…¥é•¿åº¦" step="0.01" min="0" required>
                        </div>
                    </div>

                    <div class="sample-button-group">
                        <button type="button" class="btn btn-save" onclick="saveSample()">ä¿å­˜</button>
                        <button type="button" class="btn btn-cancel" onclick="closeSampleWindow()">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- æ†å‚æ•°è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="hopkinsonModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="sample-form-container">
                <div class="sample-form-header">
                    <h2>æ†å‚æ•°è®¾ç½®</h2>
                    <p>è¯·è¾“å…¥æ†è¯¦ç»†ä¿¡æ¯</p>
                </div>

                <form id="hopkinsonForm">
                    <div class="sample-form-group">
                        <label for="hopkinsonType">æ†å‹å·</label>
                        <select id="hopkinsonType" name="hopkinsonType" onchange="changeHopkinsonType()" required>
<!--                            <option value="Hopkinson 1">Hopkinson 1</option>-->
<!--                            <option value="Hopkinson 2">Hopkinson 2</option>-->
                        </select>
                    </div>
                    <div class="sample-form-group">
                        <label for="rodMode">æ†æ¨¡å¼</label>
                        <select id="rodMode" name="rodMode" required>
                            <option value="compression">å‹æ†</option>
                            <option value="stretch">æ‹‰æ†</option>
                        </select>
                    </div>

                    <div class="sample-form-group">
                        <label for="rodMaterial">æ†æè´¨</label>
                        <input type="text" id="rodMaterial" name="rodMaterial" placeholder="è¯·è¾“å…¥æ†æè´¨" required>
                    </div>

                    <div class="sample-form-row">
                        <div class="sample-form-group">
                            <label for="rodDiameter">æˆªé¢ç›´å¾„Ã¸ (mm)</label>
                            <input type="number" id="rodDiameter" name="rodDiameter" placeholder="è¯·è¾“å…¥æˆªé¢ç›´å¾„" step="0.01" min="0" required>
                        </div>

                        <div class="sample-form-group">
                            <label for="youngsModulus">Young'sæ¨¡é‡ (GPa)</label>
                            <input type="number" id="youngsModulus" name="youngsModulus" placeholder="è¯·è¾“å…¥Young'sæ¨¡é‡" step="1000000" min="0" required>
                        </div>
                    </div>

                    <div class="sample-form-group">
                        <label for="soundVelocity">å£°é€Ÿ (m/s)</label>
                        <input type="number" id="soundVelocity" name="soundVelocity" placeholder="è¯·è¾“å…¥å£°é€Ÿ" step="1" min="0" required>
                    </div>

                    <div class="sample-form-group">
                        <label for="bridgeType">æ¡¥ç±»å‹</label>
                        <select id="bridgeType" name="bridgeType" required>
                            <option value="1">1/4æ¡¥</option>
                            <option value="2">åŠæ¡¥</option>
                            <option value="4">å…¨æ¡¥</option>
                        </select>
                    </div>

                    <div class="sample-form-row">
                        <div class="sample-form-group">
                            <label for="gageFactor">Gageå› å­</label>
                            <input type="number" id="gageFactor" name="gageFactor" placeholder="è¯·è¾“å…¥Gageå› å­" step="0.1" min="0" required>
                        </div>

                        <div class="sample-form-group">
                            <label for="excitationVoltage">æ¿€åŠ±ç”µå‹ (V)</label>
                            <input type="number" id="excitationVoltage" name="excitationVoltage" placeholder="è¯·è¾“å…¥æ¿€åŠ±ç”µå‹" step="0.1" min="0" required>
                        </div>
                    </div>

                    <div class="sample-form-group">
                        <label for="calibrationFactor">æ ‡å®šç³»æ•°</label>
                        <input type="number" id="calibrationFactor" name="calibrationFactor" placeholder="è¯·è¾“å…¥æ ‡å®šç³»æ•°" step="0.0001" min="0" required>
                    </div>
                    <div class="sample-form-row">
                        <div class="sample-form-group">
                            <label for="lengthA">ç¬¬ä¸€ä¸­å¿ƒè·</label>
                            <input type="number" id="lengthA" name="lengthA" placeholder="è¯·è¾“å…¥ç¬¬ä¸€ä¸­å¿ƒè·" step="0.01" min="0" max="0" required>
                        </div>

                        <div class="sample-form-group">
                            <label for="lengthB">ç¬¬äºŒä¸­å¿ƒè·</label>
                            <input type="number" id="lengthB" name="lengthB" placeholder="è¯·è¾“å…¥ç¬¬äºŒä¸­å¿ƒè·" step="0.01" min="0" required>
                        </div>
                    </div>

                    <div class="sample-form-row">
                        <div class="sample-form-group">
                            <label for="poissonRatio">æ³Šæ¾æ¯”</label>
                            <input type="number" id="poissonRatio" name="poissonRatio" placeholder="è¯·è¾“å…¥æ³Šæ¾æ¯”" step="0.01" min="0" max="0.5" required>
                        </div>

                        <div class="sample-form-group">
                            <label for="dampingCoefficient">é˜»å°¼ç³»æ•°</label>
                            <input type="number" id="dampingCoefficient" name="dampingCoefficient" placeholder="è¯·è¾“å…¥é˜»å°¼ç³»æ•°" step="0.01" min="0" required>
                        </div>
                    </div>

                    <div class="sample-button-group">
                        <button type="button" class="btn btn-save" onclick="saveHopkinson()">ä¿å­˜</button>
                        <button type="button" class="btn btn-cancel" onclick="closeHopkinsonWindow()">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="echarts.js"></script>



    <script>
        // æ–‡ä»¶é€‰æ‹©äº‹ä»¶å¤„ç†
        document.getElementById('incidentFile').addEventListener('change', function() {
            const file = this.files[0];
            document.getElementById('incidentFileName').innerText = file ? file.name : 'é€‰æ‹©å…¥å°„æ³¢æ–‡ä»¶';
            window.incidentFile = file;
        });

        document.getElementById('transmittedFile').addEventListener('change', function() {
            const file = this.files[0];
            document.getElementById('transmittedFileName').innerText = file ? file.name : 'é€‰æ‹©é€å°„æ³¢æ–‡ä»¶';
            window.transmittedFile = file;
        });


        // åŠ è½½æ•°æ®
        function loadData() {
            const incidentFile = window.incidentFile;
            const transmittedFile = window.transmittedFile;
            if (!incidentFile) {
                alert('è¯·é€‰æ‹©å…¥å°„æ³¢æ–‡ä»¶');
                return;
            }
            if (!transmittedFile) {
                alert('è¯·é€‰æ‹©é€å°„æ³¢æ–‡ä»¶');
                return;
            }

            const incidentReader = new FileReader();
            const transmittedReader = new FileReader();

            incidentReader.onload = function(e) {
                const incidentContent = e.target.result;
                transmittedReader.onload = function(e) {
                    const transmittedContent = e.target.result;

                    pywebview.api.loadData(incidentContent, transmittedContent)
                        .then(function(result) {
                            if(result['success']) {
                                document.getElementById('status').innerText = 'æ•°æ®åŠ è½½å®Œæˆ';
                                displayChart(result['data'][1], result['title'][1])
                                displayChart(result['data'][0], result['title'][0])
                                switchChartTab("wave");
                            }else {
                                document.getElementById('status').innerText = 'æ•°æ®åŠ è½½å¤±è´¥';
                            }
                        })
                        .catch(function(error) {
                            console.error("åŠ è½½æ•°æ®å¤±è´¥:", error);
                            document.getElementById('status').innerText = 'æ•°æ®åŠ è½½å¤±è´¥';
                        });
                };

                transmittedReader.readAsText(transmittedFile);
            };

            incidentReader.readAsText(incidentFile);

            document.getElementById('status').innerText = 'æ­£åœ¨åŠ è½½æ•°æ®...';
        }

        // æ·»åŠ å…¨å±€å˜é‡æ¥å­˜å‚¨çŸ©å½¢é€‰æ‹©ç›¸å…³æ•°æ®
        let isCtrlPressed = false;
        let isDragging = false;
        let startX = 0;
        let endX = 0;
        let selectionRect = null;

        let startIndex = -1;
        let endIndex = -1;

        // ç›‘å¬é”®ç›˜äº‹ä»¶
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey || event.key === 'Control') {
                isCtrlPressed = true;
                enableChartDrag(false);
            }
        });

        document.addEventListener('keyup', function(event) {
            if (event.key === 'Control') {
                isCtrlPressed = false;
                enableChartDrag(true);
            }
        });

        // å¯ç”¨å›¾è¡¨æ‹–åŠ¨åŠŸèƒ½
        function enableChartDrag(flag) {
            if (!currentChart)return;

            if(flag){
                // æ¢å¤åŸå§‹è®¾ç½®
                 const option = currentChart.getOption();
                 if (option && option.dataZoom){
                     const newDataZoom = option.dataZoom.map(zoom => {
                        return {
                            ...zoom,
                            disabled: false
                        };
                    });

                    currentChart.setOption({
                        dataZoom: newDataZoom
                    });
                 }
            }else{
                // ç¦ç”¨å†…ç½®ç¼©æ”¾æ‹–åŠ¨
                const option = currentChart.getOption();
                if (option && option.dataZoom) {

                    // ç¦ç”¨æ‹–åŠ¨åŠŸèƒ½
                    const newDataZoom = option.dataZoom.map(zoom => {
                        return {
                            ...zoom,
                            disabled: true
                        };
                    });

                    currentChart.setOption({
                        dataZoom: newDataZoom
                    });
                }
            }
        }

        // æ·»åŠ çŸ©å½¢é€‰æ‹©ç›‘å¬å™¨
        function addSelectionRectangleListener(chartDom) {
            // ç§»é™¤ä¹‹å‰å¯èƒ½æ·»åŠ çš„äº‹ä»¶ç›‘å¬å™¨
            chartDom.removeEventListener('mousedown', handleMouseDown);
            chartDom.removeEventListener('mousemove', handleMouseMove);
            chartDom.removeEventListener('mouseup', handleMouseUp);

            // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
            chartDom.addEventListener('mousedown', handleMouseDown);
            chartDom.addEventListener('mousemove', handleMouseMove);
            chartDom.addEventListener('mouseup', handleMouseUp);
        }

        // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶å¤„ç†
        function handleMouseDown(event) {
            if (isCtrlPressed && currentChart) {
                isDragging = true;
                const chartContainer = document.getElementById('chart');
                const rect = chartContainer.getBoundingClientRect();

                // è·å–ç›¸å¯¹äºå›¾è¡¨å®¹å™¨çš„åæ ‡
                startX = event.clientX - rect.left;

                // åˆ›å»ºæˆ–é‡ç½®é€‰æ‹©çŸ©å½¢
                if (!selectionRect) {
                    selectionRect = document.createElement('div');
                    selectionRect.style.position = 'absolute';
                    selectionRect.style.backgroundColor = 'rgba(0, 123, 255, 0.3)';
                    selectionRect.style.border = '1px solid rgba(0, 123, 255, 0.8)';
                    selectionRect.style.pointerEvents = 'none';
                    chartContainer.appendChild(selectionRect);
                }

                // è®¾ç½®åˆå§‹ä½ç½®å’Œå°ºå¯¸
                selectionRect.style.left = startX + 'px';
                selectionRect.style.top = '100px';
                selectionRect.style.width = '0px';
                selectionRect.style.height = chartContainer.clientHeight - 150 + 'px';
                selectionRect.style.display = 'block';
            }
        }

        // é¼ æ ‡ç§»åŠ¨äº‹ä»¶å¤„ç†
        function handleMouseMove(event) {
            if (isDragging && isCtrlPressed && selectionRect) {
                const chartContainer = document.getElementById('chart');
                const rect = chartContainer.getBoundingClientRect();

                // è·å–ç›¸å¯¹äºå›¾è¡¨å®¹å™¨çš„åæ ‡
                const currentX = event.clientX - rect.left;

                // è®¡ç®—å®½åº¦å’Œä½ç½®
                const width = Math.abs(currentX - startX);
                const left = Math.min(startX, currentX);

                // æ›´æ–°é€‰æ‹©çŸ©å½¢
                selectionRect.style.left = left + 'px';
                selectionRect.style.width = width + 'px';
            }
        }

        function getDataIndex(xCoord) {
            if (!currentChart) return -1;

            // è·å–ç¬¬ä¸€ä¸ªç³»åˆ—çš„æ•°æ®
            const option = currentChart.getOption();
            if (!option || !option.series || option.series.length === 0) return -1;

            const seriesData = option.series[0].data;
            if (!seriesData || seriesData.length === 0) return -1;

            // æŸ¥æ‰¾æœ€æ¥è¿‘çš„xåæ ‡çš„æ•°æ®ç‚¹ç´¢å¼•
            let minDistance = Math.abs(seriesData[0][0] - xCoord);
            let closestIndex = 0;

            for (let i = 1; i < seriesData.length; i++) {
                const distance = Math.abs(seriesData[i][0] - xCoord);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestIndex = i;
                }
            }

            return closestIndex;
        }

        // é¼ æ ‡é‡Šæ”¾äº‹ä»¶å¤„ç†
        function handleMouseUp(event) {
            if (isDragging && isCtrlPressed && selectionRect) {
                isDragging = false;

                const chartContainer = document.getElementById('chart');
                const rect = chartContainer.getBoundingClientRect();

                // è·å–ç›¸å¯¹äºå›¾è¡¨å®¹å™¨çš„åæ ‡
                endX = event.clientX - rect.left;

                // ç¡®ä¿startXæ˜¯è¾ƒå°å€¼ï¼ŒendXæ˜¯è¾ƒå¤§å€¼
                const minX = Math.min(startX, endX);
                const maxX = Math.max(startX, endX);

                // éšè—é€‰æ‹©çŸ©å½¢
                selectionRect.style.display = 'none';

                 // è½¬æ¢åƒç´ åæ ‡ä¸ºæ•°æ®åæ ‡
                const chartCoordStart = currentChart.convertFromPixel({seriesIndex: 0}, [minX, 0]);
                const chartCoordEnd = currentChart.convertFromPixel({seriesIndex: 0}, [maxX, 0]);

                // è·å–æ•°æ®ç‚¹ç´¢å¼•
                startIndex = getDataIndex(chartCoordStart[0]);
                endIndex = getDataIndex(chartCoordEnd[0]);


                document.getElementById('serialModal').style.display = 'flex';
            }

            isDragging = false;
        }

        function checkSerial(){
            if(startIndex === -1 || endIndex === -1){
                alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„æ•°æ®èŒƒå›´ï¼');
                return;
            }
            const type = document.getElementById('serialType').value;
            // è¿™é‡Œå¯ä»¥è°ƒç”¨å…¶ä»–å‡½æ•°å¤„ç†é€‰æ‹©åŒºåŸŸ
            handleSelectionComplete(startIndex, endIndex, type);
            closeSerial();
        }

        function closeSerial(){
            document.getElementById('serialModal').style.display = 'none';
        }


        // å¤„ç†é€‰æ‹©å®Œæˆçš„å›è°ƒå‡½æ•°
        let displayList = {};
        function handleSelectionComplete(startX, endX,  type) {
            console.log('é€‰æ‹©å®Œæˆï¼Œèµ·å§‹Xåæ ‡:', startX, 'ç»“æŸXåæ ‡:', endX);
            document.getElementById('status').innerText = `å·²é€‰æ‹©åŒºåŸŸ: ${startX.toFixed(2)} åˆ° ${endX.toFixed(2)} (${type})`;
            pywebview.api.cropSignal(startX, endX, type).then((result) => {
                if(result.success){
                    displayList[result.title] = result.data;
                }
                else{
                    alert('è£å‰ªå¤±è´¥ï¼');
                }
                console.log(result.message);
            });
        }


        // å£°æ˜å…¨å±€å˜é‡ä¿å­˜å›¾è¡¨å®ä¾‹
        let currentChart = null;

        // é¡µé¢åŠ è½½ååˆå§‹åŒ– ECharts å®ä¾‹
        document.addEventListener('DOMContentLoaded', function () {
            const chartDom = document.getElementById('chart');
            if (chartDom) {
                currentChart = echarts.init(chartDom);
                displayChart([], "æ— æ•°æ®å¯¼å…¥");
            }
        });

        function displayChart(data, title) {
            try {
                console.log('å¼€å§‹æ¸²æŸ“å›¾è¡¨:', data, title);
                if (data && title) {
                    displayList[title] = data;
                }

                const chartDom = document.getElementById('chart');
                if (!chartDom) {
                    console.error('æ‰¾ä¸åˆ° chart å…ƒç´ ');
                    return;
                }

                // æ£€æŸ¥ echarts æ˜¯å¦å¯ç”¨
                if (typeof echarts === 'undefined') {
                    console.error('ECharts åº“æœªåŠ è½½');
                    chartDom.innerHTML = '<div style="color:red;text-align:center;padding:20px;">å›¾è¡¨åº“åŠ è½½å¤±è´¥</div>';
                    return;
                }

                // å¦‚æœè¿˜æ²¡æœ‰åˆå§‹åŒ–å›¾è¡¨å®ä¾‹ï¼Œåˆ™è¿›è¡Œåˆå§‹åŒ–
                if (!currentChart) {
                    currentChart = echarts.init(chartDom);
                }

                // å¤„ç†å¤šæ¡æ›²çº¿æ•°æ®
                const series = [];
                const legendData = [];

                // å®šä¹‰æœ€å¤§æ˜¾ç¤ºç‚¹æ•°
                const MAX_POINTS = 5000000;

                for (const key in data) {
                    if (data[key]){
                        let sampledData = data[key]["y"];
                        let sampledX = data[key]["x"];

                        // å¦‚æœæ•°æ®é‡è¶…è¿‡æœ€å¤§ç‚¹æ•°ï¼Œåˆ™è¿›è¡Œé‡‡æ ·
                        if (sampledData.length > MAX_POINTS) {
                            const step = Math.ceil(sampledData.length / MAX_POINTS);
                            sampledData = sampledData.filter((_, index) => index % step === 0);
                            sampledX = sampledX.filter((_, index) => index % step === 0);
                        }

                        series.push({
                            name: key,
                            type: 'line',
                            smooth: true,
                            sampling: 'lttb', // ECharts æä¾›çš„é‡‡æ ·ç®—æ³•
                            showSymbol: false,
                            data: sampledX.map((x, index) => [x, sampledData[index]])
                        });
                        legendData.push(key);
                    }
                }


                const option = {
                    title: {
                        text: title,
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'axis'
                    },
                    legend: {
                        data: legendData,
                        top: '10%'
                    },
                    xAxis: {
                        type: 'value'
                    },
                    yAxis: {
                        type: 'value'
                    },
                    series: series,
                    dataZoom: [  // æ·»åŠ æ•°æ®ç¼©æ”¾åŠŸèƒ½
                        {
                            type: 'inside',
                            start: 0,
                            end: 100
                        },
                        {
                            start: 0,
                            end: 100
                        }
                    ]
                };

                currentChart.setOption(option, true); // ä½¿ç”¨ notMerge æ¨¡å¼æ›´æ–°é…ç½®

                // æ·»åŠ é¼ æ ‡äº‹ä»¶ç›‘å¬å™¨å®ç°çŸ©å½¢é€‰æ‹©åŠŸèƒ½
                addSelectionRectangleListener(chartDom);

                // ç¡®ä¿å›¾è¡¨æ­£ç¡®æ¸²æŸ“å¤§å°
                setTimeout(() => {
                    if (currentChart) {
                        currentChart.resize();
                    }
                }, 100);

                console.log('å›¾è¡¨æ¸²æŸ“æˆåŠŸ');
            } catch (error) {
                console.error('å›¾è¡¨æ¸²æŸ“å¤±è´¥:', error);
                // åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                const chartDom = document.getElementById('chart');
                if (chartDom) {
                    chartDom.innerHTML = `<div style="color:red;text-align:center;padding:20px;">æ¸²æŸ“å¤±è´¥: ${error.message}</div>`;
                }
            }
        }


        // æ‰“å¼€æ ·å“å¯¹è¯æ¡†
        function openNewSampleDialog() {
            pywebview.api.getCacheData().then(function(result) {
                if(result['success']) {
                    const sampleData = result['data']['sample'];
                    if (sampleData) {
                        // æ­£ç¡®è®¾ç½®è¡¨å•å­—æ®µçš„å€¼
                        document.getElementById('sampleNumber').value = sampleData['number'] || '';
                        document.getElementById('sampleName').value = sampleData['name'] || '';
                        document.getElementById('sampleMaterial').value = sampleData['material'] || '';
                        document.getElementById('sampleArea').value = sampleData['area'] || '';
                        document.getElementById('sampleLength').value = sampleData['length'] || '';
                    }
                } else {
                    document.getElementById('status').innerText = 'å†å²æ•°æ®ä¸å­˜åœ¨';
                }
                document.getElementById('sampleModal').style.display = 'flex';
            })
            .catch(function(error) {
                console.error("åŠ è½½æ•°æ®å¤±è´¥:", error);
                document.getElementById('status').innerText = 'æ•°æ®åŠ è½½å¤±è´¥';
                document.getElementById('sampleModal').style.display = 'flex';
            });
        }

        // å…³é—­æ ·å“å¯¹è¯æ¡†
        function closeSampleWindow() {
            document.getElementById('sampleModal').style.display = 'none';
        }

        //ä¿å­˜æ ·å“
        function saveSample() {
            // è·å–è¡¨å•æ•°æ®
            const sampleData = {
                number: document.getElementById('sampleNumber').value,
                name: document.getElementById('sampleName').value,
                material: document.getElementById('sampleMaterial').value,
                area: document.getElementById('sampleArea').value,
                length: document.getElementById('sampleLength').value
            };

            // æ•°æ®éªŒè¯
            if (!sampleData.name || !sampleData.material || !sampleData.area || !sampleData.length) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                return;
            }

            if (window.pywebview) {
                pywebview.api.saveSampleData(sampleData)
                    .then(function(result) {
                        console.log('æ ·å“æ•°æ®ä¿å­˜æˆåŠŸ:', result);
                        document.getElementById('sampleDisplay').innerText =
                            `ç¼–å·: ${sampleData.number}
                             æ ·å“: ${sampleData.name}
                             æè´¨ï¼š${sampleData.material}
                             ç›´å¾„ï¼š${sampleData.area}
                             é•¿åº¦ï¼š${sampleData.length}\n`;
                    })
                    .catch(function(error) {
                        console.error('ä¿å­˜æ ·å“æ•°æ®å¤±è´¥:', error);
                    });
            }

            closeSampleWindow();
        }


        //æ‰“å¼€æ–°å»ºæ†å¯¹è¯æ¡†
        // æ‰€æœ‰æ†å‹å·
        let hopkinsonList ={}
        function openNewHopkinsonDialog() {
            pywebview.api.getCacheData().then(function(result) {
                if(result['success']) {
                    const hopkinsonData = result['data']['hopkinson'];
                    hopkinsonList = result['data']['hopkinsonList'];
                    for (let key in hopkinsonList) {
                         document.getElementById('hopkinsonType').innerHTML += '<option value="' + key + '">' + key + '</option>';
                    }
                    if (hopkinsonData) {
                        // æ­£ç¡®è®¾ç½®è¡¨å•å­—æ®µçš„å€¼
                        document.getElementById('hopkinsonType').value = hopkinsonData['type'] || '';
                        document.getElementById('rodMode').value = hopkinsonData['mode'] || '';
                        document.getElementById('rodMaterial').value = hopkinsonData['material'] || '';
                        document.getElementById('rodDiameter').value = hopkinsonData['diameter'] || '';
                        document.getElementById('youngsModulus').value = hopkinsonData['youngs'] || '';
                        document.getElementById('soundVelocity').value = hopkinsonData['soundVelocity'] || '';
                        document.getElementById('bridgeType').value = hopkinsonData['bridgeType'] || '';
                        document.getElementById('gageFactor').value = hopkinsonData['gageFactor'] || '';
                        document.getElementById('excitationVoltage').value = hopkinsonData['excitationVoltage'] || '';
                        document.getElementById('calibrationFactor').value = hopkinsonData['calibrationFactor'] || '';
                        document.getElementById('lengthA').value = hopkinsonData['lengthA'] || '';
                        document.getElementById('lengthB').value = hopkinsonData['lengthB'] || '';
                        document.getElementById('poissonRatio').value = hopkinsonData['poissonRatio'] || '';
                        document.getElementById('dampingCoefficient').value = hopkinsonData['dampingCoefficient'] || '';
                    }
                } else {
                    document.getElementById('status').innerText = 'å†å²æ•°æ®ä¸å­˜åœ¨';
                }
            })
            .catch(function(error) {
                console.error("åŠ è½½æ•°æ®å¤±è´¥:", error);
                document.getElementById('status').innerText = 'æ•°æ®åŠ è½½å¤±è´¥';
            });
            document.getElementById('hopkinsonModal').style.display = 'flex';

        }

        function changeHopkinsonType(){
            const type = document.getElementById('hopkinsonType').value;
            if(hopkinsonList[type]){
                document.getElementById('rodMode').value = hopkinsonList[type]['mode']|| '';
                document.getElementById('rodMaterial').value = hopkinsonList[type]['material']|| '';
                document.getElementById('rodDiameter').value = hopkinsonList[type]['diameter']|| '';
                document.getElementById('youngsModulus').value = hopkinsonList[type]['youngs']|| '';
                document.getElementById('soundVelocity').value = hopkinsonList[type]['soundVelocity']|| '';
                document.getElementById('bridgeType').value = hopkinsonList[type]['bridgeType']|| '';
                document.getElementById('gageFactor').value = hopkinsonList[type]['gageFactor']|| '';
                document.getElementById('excitationVoltage').value = hopkinsonList[type]['excitationVoltage']|| '';
                document.getElementById('calibrationFactor').value = hopkinsonList[type]['calibrationFactor']|| '';
                document.getElementById('poissonRatio').value = hopkinsonList[type]['poissonRatio']|| '';
                document.getElementById('dampingCoefficient').value = hopkinsonList[type]['dampingCoefficient']|| '';
                document.getElementById('status').innerText = 'æ•°æ®åŠ è½½æˆåŠŸ';
            }

        }


        // å…³é—­æ–°å»ºæ†å¯¹è¯æ¡†
        function closeHopkinsonWindow() {
            document.getElementById('hopkinsonModal').style.display = 'none';
        }

        //ä¿å­˜æ†æ•°æ®
        function saveHopkinson() {
            // è·å–è¡¨å•æ•°æ®
            const HopkinsonData = {
                type: document.getElementById('hopkinsonType').value,
                mode: document.getElementById('rodMode').value,
                material: document.getElementById('rodMaterial').value,
                diameter: document.getElementById('rodDiameter').value,
                youngs: document.getElementById('youngsModulus').value,
                soundVelocity: document.getElementById('soundVelocity').value,
                bridgeType: document.getElementById('bridgeType').value,
                gageFactor: document.getElementById('gageFactor').value,
                excitationVoltage: document.getElementById('excitationVoltage').value,
                calibrationFactor: document.getElementById('calibrationFactor').value,
                poissonRatio: document.getElementById('poissonRatio').value,
                dampingCoefficient: document.getElementById('dampingCoefficient').value,
                lengthB: document.getElementById('lengthB').value,
                lengthA: document.getElementById('lengthA').value,
            };

            if (window.pywebview) {
                pywebview.api.saveHopkinsonData(HopkinsonData)
                    .then(function(result) {
                        console.log('æ†æ•°æ®ä¿å­˜æˆåŠŸ:', result);
                        document.getElementById('rodParameters').innerText =
                            `æ†: ${HopkinsonData.type} (${HopkinsonData.mode})
                            æè´¨ï¼š${HopkinsonData.material}
                            ç›´å¾„ï¼š${HopkinsonData.diameter}
                            æ¨æ°æ¨¡é‡ï¼š${HopkinsonData.youngs}
                            æ³¢é€Ÿï¼š${HopkinsonData.soundVelocity}
                            æ¡¥ç±»å‹ï¼š${HopkinsonData.bridgeType}
                            çµæ•ç³»æ•°ï¼š${HopkinsonData.gageFactor}
                            æ¿€åŠ±ç”µå‹ï¼š${HopkinsonData.excitationVoltage}
                            æ ‡å®šç³»æ•°ï¼š${HopkinsonData.calibrationFactor}
                            ç¬¬ä¸€ä¸­å¿ƒè·ï¼š${HopkinsonData.lengthA}
                            ç¬¬äºŒä¸­å¿ƒè·ï¼š${HopkinsonData.lengthB}
                            æ³Šæ¾æ¯”ï¼š${HopkinsonData.poissonRatio}
                            é˜»å°¼ç³»æ•°ï¼š${HopkinsonData.dampingCoefficient}\n`;
                    })
                    .catch(function(error) {
                        console.error('ä¿å­˜æ†æ•°æ®å¤±è´¥:', error);
                    })
            }
            closeHopkinsonWindow();
        }


        // æ›´æ–°é¢‘ç‡æ»‘å—å€¼
        function updateLowFreq(value) {
            document.getElementById('lowFreqValue').innerText = `${value} Hz`;
        }

        function updateHighFreq(value) {
            document.getElementById('highFreqValue').innerText = `${value} Hz`;
        }

        function updateIncBaseline(value) {
            document.getElementById('IncBaselineInput').value = (value - 500)/500;
            pywebview.api.baselineCorrection((value - 500)/500, 'inc').then(function(result){
                if (result) {
                    // ä¿å­˜ç¼©æ”¾è®¾ç½®
                    if (!window.originalDataZoom) {
                        window.originalDataZoom = JSON.parse(JSON.stringify(currentChart.getOption().dataZoom));
                    }
                    window.originalDataZoom = JSON.parse(JSON.stringify(currentChart.getOption().dataZoom));

                    displayChart(result['data'], result['title'])
                    switchChartTab('wave');

                    // ä¿æŒç”»é¢ç¼©æ”¾
                    currentChart.setOption({
                        dataZoom: window.originalDataZoom
                    });
                    document.getElementById('status').innerHTML = 'åŸºçº¿è°ƒæ•´å®Œæˆ';
                } else {
                    document.getElementById('status').innerHTML = 'åŸºçº¿è°ƒæ•´å¤±è´¥';
                }
            })

        }

        function updateTransBaseline(value) {
            document.getElementById('TransBaselineInput').value = (value - 500)/500;
            pywebview.api.baselineCorrection((value - 500)/500, 'trans').then(function(result){
                if (result) {
                    // ä¿å­˜ç¼©æ”¾è®¾ç½®
                    if (!window.originalDataZoom) {
                        window.originalDataZoom = JSON.parse(JSON.stringify(currentChart.getOption().dataZoom));
                    }
                    window.originalDataZoom = JSON.parse(JSON.stringify(currentChart.getOption().dataZoom));

                    displayChart(result['data'], result['title'])
                    switchChartTab('wave');

                    // ä¿æŒç”»é¢ç¼©æ”¾
                    currentChart.setOption({
                        dataZoom: window.originalDataZoom
                    });
                    document.getElementById('status').innerHTML = 'åŸºçº¿è°ƒæ•´å®Œæˆ';
                } else {
                    document.getElementById('status').innerHTML = 'åŸºçº¿è°ƒæ•´å¤±è´¥';
                }
            })
        }


        //æ—¶åŸŸå¯¹é½
        function alignWithTime(){
            let maxValue = document.getElementById('incManually').max;
            document.getElementById('incManually').value = maxValue/2;
            updateInc(maxValue/2)

            maxValue = document.getElementById('transManually').max;
            document.getElementById('transManually').value = maxValue/2;
            updateTrans(maxValue/2);

            maxValue = document.getElementById('refManually').max;
            document.getElementById('refManually').value = maxValue/2;
            updateRef(maxValue/2);

            pywebview.api.alignWithTime()
                .then(function(result) {
                    if(result['success']){
                        displayChart(result['data'], result['title'])
                        switchChartTab("crop");
                        document.getElementById('status').innerText = 'å·²æ—¶åŸŸå¯¹é½';
                    }else{
                        document.getElementById('status').innerText = 'æ—¶åŸŸå¯¹é½å¤±è´¥';
                    }
                })
                .catch(function(error) {
                    console.error('æ—¶åŸŸå¯¹é½å¤±è´¥', error);
                });


        }

        // æ‰‹åŠ¨æ—¶åŸŸå¯¹é½
        let alignManuallyShow = false
        function alignManually() {
            if(alignManuallyShow){
                document.getElementById('alignManually').style.display = 'none';
                alignManuallyShow = false;
            }else
            {
                document.getElementById('alignManually').style.display = 'block';
                switchChartTab("crop");
                alignManuallyShow = true;
            }
        }


        // åŒæ­¥æ»‘å—å’Œè¾“å…¥æ¡†çš„å€¼
        function syncSliderAndInput(sliderId, inputId, value) {
            document.getElementById(sliderId).value = document.getElementById(sliderId).max/2 + value;
            document.getElementById(inputId).value = value;
        }

        // ä»è¾“å…¥æ¡†æ›´æ–°å…¥å°„æ³¢
        function updateIncFromInput(value) {
            const maxValue = document.getElementById('incManually').max;
            value = Math.max(0, Math.min(maxValue, parseInt(value) || 0));
            syncSliderAndInput('incManually', 'incManuallyInput', value);
            updateInc(maxValue/2 + value);
        }

        // ä»è¾“å…¥æ¡†æ›´æ–°åå°„æ³¢
        function updateRefFromInput(value) {
            const maxValue = document.getElementById('refManually').max;
            value = Math.max(0, Math.min(maxValue, parseInt(value) || 0));
            syncSliderAndInput('refManually', 'refManuallyInput', value);
            updateRef(maxValue/2 + value);
        }

        // ä»è¾“å…¥æ¡†æ›´æ–°é€å°„æ³¢
        function updateTransFromInput(value) {
            const maxValue = document.getElementById('transManually').max;
            value = Math.max(0, Math.min(maxValue, parseInt(value) || 0));
            syncSliderAndInput('transManually', 'transManuallyInput', value);
            updateTrans(maxValue/2 + value);
        }

        function updateInc(value) {
            const maxValue = document.getElementById('incManually').max;
            document.getElementById('incManuallyInput').value = value - maxValue/2;
            pywebview.api.alignManually(value, "inc", maxValue)
                .then(function(result) {
                    if(result['success']){
                        displayChart(result['data'], result['title'])
                        switchChartTab("crop");
                        document.getElementById('status').innerText = 'å·²æ—¶åŸŸå¯¹é½';
                    }else{
                        document.getElementById('status').innerText = 'æ—¶åŸŸå¯¹é½å¤±è´¥';
                    }
                })
                .catch(function(error) {
                    console.error('æ›´æ–°å¤±è´¥:', error);
                });

        }

        function updateRef(value) {
            const maxValue = document.getElementById('refManually').max;
            document.getElementById('refManuallyInput').value = value - maxValue/2;
            pywebview.api.alignManually(value, "ref", maxValue)
                .then(function(result) {
                   if(result['success']){
                        displayChart(result['data'], result['title'])
                        switchChartTab("crop");
                        document.getElementById('status').innerText = 'å·²æ—¶åŸŸå¯¹é½';
                    }else{
                        document.getElementById('status').innerText = 'æ—¶åŸŸå¯¹é½å¤±è´¥';
                    }
                })
                .catch(function(error) {
                    console.error('æ›´æ–°å¤±è´¥:', error);
                });
        }

        function updateTrans(value) {
            const maxValue = document.getElementById('transManually').max;
            document.getElementById('transManuallyInput').value = value - maxValue/2;
            pywebview.api.alignManually(value, "trans", maxValue)
                .then(function(result) {
                    if(result['success']){
                        displayChart(result['data'], result['title'])
                        switchChartTab("crop");
                        document.getElementById('status').innerText = 'å·²æ—¶åŸŸå¯¹é½';
                    }else{
                        document.getElementById('status').innerText = 'æ—¶åŸŸå¯¹é½å¤±è´¥';
                    }
                })
                .catch(function(error) {
                    console.error('æ›´æ–°å¤±è´¥:', error);
                });
        }

        // åº”ç”¨æ»¤æ³¢
        function applyFilter() {
            const lowFreq = document.getElementById('lowFreqSlider').value;
            const highFreq = document.getElementById('highFreqSlider').value;

            // ä¿å­˜ç¼©æ”¾è®¾ç½®
            if (!window.originalDataZoom) {
                window.originalDataZoom = JSON.parse(JSON.stringify(currentChart.getOption().dataZoom));
            }
            window.originalDataZoom = JSON.parse(JSON.stringify(currentChart.getOption().dataZoom));

            if (window.pywebview) {
                pywebview.api.applyFilter(lowFreq, highFreq)
                    .then(function(result) {
                        if(result['success']){
                            displayChart(result['data'], result['title'])
                            switchChartTab("wave");
                            document.getElementById('status').innerText = `å·²åº”ç”¨ ${lowFreq}-${highFreq} Hz æ»¤æ³¢`;

                            // ä¿æŒç”»é¢ç¼©æ”¾
                            currentChart.setOption({
                                dataZoom: window.originalDataZoom
                            });
                        }else{
                            document.getElementById('status').innerText = 'æ»¤æ³¢å¤±è´¥';
                        }
                    })
                    .catch(function(error) {
                        console.error('æ»¤æ³¢å¤±è´¥', error);
                        document.getElementById('status').innerText = 'æ»¤æ³¢å¤±è´¥';
                    })
            }

        }

        // å¼€å§‹è®¡ç®—
        function startCalculation() {
            const calculationType = document.getElementById('calculateMethod').value;
            pywebview.api.startCalculation(calculationType).then(function(result) {
                if(result['success']){
                    displayChart(result['data'], result['title'])
                    switchChartTab("result");
                    document.getElementById('status').innerText = 'è®¡ç®—å®Œæˆ!' ;
                }else{
                    document.getElementById('status').innerText = 'è®¡ç®—å¤±è´¥!';
                }
            });
        }

        // å¯¼å‡ºç»“æœ
        function exportResults() {
            pywebview.api.exportResults()
                .then(function(result) {
                    if(result['success']){
                        document.getElementById('status').innerText = 'ç»“æœå·²å¯¼å‡º';
                    }else{
                        document.getElementById('status').innerText = 'ç»“æœå¯¼å‡ºå¤±è´¥';
                    }
                    alert(result['message']);
                })
                .catch(function(error) {
                    console.error('ç»“æœå¯¼å‡ºå¤±è´¥:', error);
                });
        }

        // é€‰é¡¹å¡åˆ‡æ¢åŠŸèƒ½
        function switchChartTab(tabName) {
            // æ›´æ–°é€‰é¡¹å¡æŒ‰é’®æ ·å¼
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(btn => {
                btn.style.background = '#e0e0e0';
                btn.style.color = 'black';
                btn.classList.remove('active');
            });

            document.getElementById(tabName).style.background = '#4CAF50';
            document.getElementById(tabName).style.color = 'white';
            document.getElementById(tabName).classList.add('active');

            // æ ¹æ®é€‰é¡¹å¡æ˜¾ç¤ºä¸åŒå†…å®¹
            switch(tabName) {
                case 'wave':
                    displayChart(displayList["åŸå§‹æ•°æ®"], "åŸå§‹æ•°æ®");
                    document.getElementById('status').innerText = 'å·²æ˜¾ç¤ºåŸå§‹æ•°æ®';
                    break;
                case 'fft':
                    displayChart(displayList["é¢‘è°±æ•°æ®"], "é¢‘è°±æ•°æ®");
                    break;
                case 'crop':
                    displayChart(displayList["æ—¶åŸŸå¯¹é½"], "æ—¶åŸŸå¯¹é½");
                    break;
                case 'result':
                    displayChart(displayList["å·¥ç¨‹åº”åŠ›åº”å˜"], "å·¥ç¨‹åº”åŠ›åº”å˜");
                    break;
            }

        }

        // çª—å£å¤§å°å˜åŒ–ç›‘å¬
        window.addEventListener('resize', function() {
            // è·å–æ‰€æœ‰EChartså®ä¾‹å¹¶è°ƒæ•´å¤§å°
            if (typeof echarts !== 'undefined' && echarts.getInstanceByDom) {
                const chartDom = document.getElementById('chart');
                if (chartDom) {
                    const chartInstance = echarts.getInstanceByDom(chartDom);
                    if (chartInstance) {
                        chartInstance.resize();
                    }
                }
            }
        });


        // è§†å›¾æ§åˆ¶ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function zoomIn() { alert('æ”¾å¤§åŠŸèƒ½å¾…å®ç°'); }
        function zoomOut() { alert('ç¼©å°åŠŸèƒ½å¾…å®ç°'); }
        function togglePan() { alert('æ‹–åŠ¨æ¨¡å¼å¾…å®ç°'); }
        function resetView() { renderChart(); }

    </script>
</body>
</html>